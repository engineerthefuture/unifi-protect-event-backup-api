openapi: 3.0.3
info:
  title: Unifi Protect Event Backup API
  version: 1.0.0
  description: |
    AWS Lambda function that receives and processes webhook events from Unifi Dream Machine Protect systems,
    storing alarm event data and video files in S3 for backup and analysis.
  contact:
    name: Brent Foster
    url: https://github.com/engineerthefuture/unifi-protect-event-backup-api

servers:
  - url: https://{api}.execute-api.{region}.amazonaws.com/{stage}
    variables:
      api:
        default: your-api-id
      region:
        default: us-east-1
      stage:
        default: prod

security:
  - ApiKeyAuth: []

paths:
  /alarmevent:
    post:
      summary: Process Unifi Protect alarm webhook
      description: |
        Receives webhook events from Unifi Protect systems, validates and queues them for delayed processing.
        The endpoint returns immediately with queue metadata; processing (video download, enrichment, storage)
        is performed asynchronously.
      operationId: processAlarmEvent
      tags:
        - Alarm Events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnifiWebhookRequest'
            examples:
              motionDetection:
                summary: Motion Detection Event
                description: Typical motion detection event from an outdoor camera
                value:
                  alarm:
                    name: "Backup Alarm Event"
                    sources:
                      - device: "28704E113F64"
                        type: "include"
                    conditions:
                      - condition:
                          type: "is"
                          source: "motion"
                    triggers:
                      - key: "motion"
                        device: "28704E113F33"
                        eventId: "67b389ab005ec703e40075a5"
                        zones:
                          zone: []
                          line: []
                          loiter: []
                  timestamp: 1739819436108
              personDetection:
                summary: Person Detection Event
                value:
                  alarm:
                    name: "Person Detection Alarm"
                    sources:
                      - device: "F4E2C67A2FE8"
                        type: "include"
                    conditions:
                      - condition:
                          type: "is"
                          source: "person"
                    triggers:
                      - key: "person"
                        device: "F4E2C67A2FE8"
                        eventId: "67b389ab005ec703e40075a6"
                        zones:
                          zone: ["entrance", "driveway"]
                          line: []
                          loiter: []
                  timestamp: 1739819500000
              vehicleDetection:
                summary: Vehicle Detection Event
                value:
                  alarm:
                    name: "Vehicle Detection Alarm"
                    sources:
                      - device: "28704E113C44"
                        type: "include"
                    conditions:
                      - condition:
                          type: "is"
                          source: "vehicle"
                    triggers:
                      - key: "vehicle"
                        device: "28704E113C44"
                        eventId: "67b389ab005ec703e40075a7"
                        zones:
                          zone: ["street", "driveway"]
                          line: ["property_line"]
                          loiter: []
                  timestamp: 1739819600000
      responses:
        '200':
          description: Event successfully queued for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueuedEventResponse'
        '400':
          description: Bad request - invalid or malformed data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many requests - rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    options:
      summary: CORS preflight request
      description: Returns CORS headers for browser preflight requests
      operationId: handleCorsOptions
      tags:
        - CORS
      responses:
        '200':
          description: CORS headers provided
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: "*"
            Access-Control-Allow-Methods:
              schema:
                type: string
              example: "OPTIONS,POST,GET"
            Access-Control-Allow-Headers:
              schema:
                type: string
              example: "Content-Type,X-API-Key"
            Access-Control-Max-Age:
              schema:
                type: integer
              example: 86400

  /:
    get:
      summary: Download video by event ID
      description: Returns a presigned S3 URL for the video file that matches the provided eventId.
      operationId: getVideoByEventId
      tags:
        - Video Retrieval
      parameters:
        - name: eventId
          in: query
          required: true
          schema:
            type: string
            pattern: '^[a-fA-F0-9]{24}$'
          description: Unifi Protect event identifier (24 hex chars)
      responses:
        '200':
          description: Video download URL successfully generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoDownloadResponse'
        '400':
          description: Missing or invalid eventId
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event or video not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /latestvideo:
    get:
      summary: Get latest video download URL
      description: Finds the most recent video file and returns a presigned S3 URL.
      operationId: getLatestVideo
      tags:
        - Video Retrieval
      responses:
        '200':
          description: Latest video metadata and download URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoDownloadResponse'
        '404':
          description: No video files found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /metadata:
    get:
      summary: Fetch camera metadata from Unifi Protect and store in S3
      description: Retrieves camera metadata from Unifi Protect and saves it as metadata/cameras.json in S3.
      operationId: fetchMetadata
      tags:
        - Metadata
      responses:
        '200':
          description: Metadata fetched and stored successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  metadata:
                    type: object
        '401':
          description: Unauthorized - missing or invalid API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key required for all requests

  schemas:
    UnifiWebhookRequest:
      type: object
      required:
        - alarm
        - timestamp
      properties:
        alarm:
          $ref: '#/components/schemas/AlarmObject'
        timestamp:
          type: integer
          format: int64
          example: 1739819436108

    AlarmObject:
      type: object
      required:
        - name
        - triggers
      properties:
        name:
          type: string
        sources:
          type: array
          items:
            $ref: '#/components/schemas/AlarmSource'
        conditions:
          type: array
          items:
            $ref: '#/components/schemas/AlarmCondition'
        triggers:
          type: array
          items:
            $ref: '#/components/schemas/AlarmTrigger'

    AlarmSource:
      type: object
      properties:
        device:
          type: string
        type:
          type: string

    AlarmCondition:
      type: object
      properties:
        condition:
          type: object
          properties:
            type:
              type: string
            source:
              type: string

    AlarmTrigger:
      type: object
      required:
        - key
        - device
        - eventId
      properties:
        key:
          type: string
        device:
          type: string
        eventId:
          type: string
        zones:
          type: object

    QueuedEventResponse:
      type: object
      properties:
        msg:
          type: string
        eventId:
          type: string
        device:
          type: string
        processingDelay:
          type: integer
        messageId:
          type: string
        estimatedProcessingTime:
          type: string

    VideoDownloadResponse:
      type: object
      properties:
        downloadUrl:
          type: string
          format: uri
        filename:
          type: string
        videoKey:
          type: string
        eventKey:
          type: string
        timestamp:
          type: integer
        eventDate:
          type: string
        expiresAt:
          type: string
        eventData:
          type: object

    ErrorResponse:
      type: object
      properties:
        msg:
          type: string

tags:
  - name: Alarm Events
    description: Processing of incoming alarm webhook events
  - name: Video Retrieval
    description: Endpoints to retrieve video files and presigned URLs
  - name: Metadata
    description: Fetch and store camera metadata
  - name: CORS
    description: Cross-Origin Resource Sharing support

externalDocs:
  url: https://github.com/engineerthefuture/unifi-protect-event-backup-api
  description: Project documentation and README
        '404':
          description: Event or video not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                eventNotFound:
                  summary: Event with specified eventId not found
                  value:
                    msg: "Event with eventId 67b389ab005ec703e40075a5 not found"
                videoFileNotFound:
                  summary: Event found but video file missing
                  value:
                    msg: "Video file for event 67b389ab005ec703e40075a5 not found"
                searchTimeout:
                  summary: Event not found within search timeframe
                  value:
                    msg: "Event with eventId 67b389ab005ec703e40075a5 not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                s3Error:
                  summary: S3 access error
                  value:
                    msg: "Failed to retrieve event from S3: Access denied"
                configError:
                  summary: Configuration error
                  value:
                    msg: "Server configuration error: StorageBucket not configured"

  /latestvideo:
    get:
      summary: Get latest video download URL
      description: |
        Finds the most recent video file (.mp4) from stored alarm events and returns a presigned URL for download.
        
        **Why Presigned URL?**
        Video files typically exceed API Gateway's 6MB payload limit, so instead of returning the video data directly,
        this endpoint returns a secure, time-limited URL that allows direct download from S3. This approach is more
        efficient and can handle videos of any size.
        
        **Search Algorithm:**
        This endpoint uses an optimized search that efficiently searches through date-organized 
        folders in S3 to find the most recent video file. It starts from today's date folder 
        and works backwards day by day until a video is found, making it much more efficient 
        than scanning all objects in the bucket.
        
        **Search Process:**
        1. Start from today's date folder (YYYY-MM-DD format)
        2. Search for .mp4 files in that folder
        3. If found, return metadata for the one with the highest timestamp
        4. If not found, move to previous day and repeat
        5. Continue for up to 30 days maximum
        
        **File Format:**
        Video files follow the naming pattern: `{eventId}_{deviceMac}_{timestamp}.mp4`
        - **deviceMac**: 12-character hexadecimal MAC address
        - **timestamp**: Unix timestamp in milliseconds when the event occurred
        
        **Storage Organization:**
        Videos are stored in S3 with date-based organization:
        `s3://{bucket}/{YYYY-MM-DD}/{eventId}_{deviceMac}_{timestamp}.mp4`
        
        **Response Format:**
        Returns JSON containing:
        - **downloadUrl**: Presigned S3 URL for direct download (expires in 1 hour)
        - **filename**: Suggested filename for download
        - **metadata**: Event timestamp, date, and video key information
        - **eventData**: Complete alarm event details including device name, trigger type, zones, and timestamps
        
        **Security:**
        - Presigned URLs expire after 1 hour for security
        - URLs include proper Content-Disposition headers for filename handling
        - Direct S3 access without requiring API credentials
        
        **Use Cases:**
        - Quick access to most recent security footage
        - Automated monitoring systems that can handle URLs
        - Mobile applications for security alerts
        - Integration with notification systems
      operationId: getLatestVideo
      tags:
        - Video Retrieval
      responses:
        '200':
          description: Latest video metadata and download URL successfully retrieved
          content:
            application/json:
              schema:
                type: object
                required:
                  - downloadUrl
                  - filename
                  - videoKey
                  - eventKey
                  - timestamp
                  - eventDate
                  - expiresAt
                  - message
                properties:
                  downloadUrl:
                    type: string
                    format: uri
                    description: |
                      Presigned S3 URL for direct video download. This URL expires after 1 hour for security.
                      The URL includes proper headers to suggest the filename when downloaded.
                    example: "https://s3.amazonaws.com/bucket/2025-01-17/28704E113F33_1739819436108.mp4?AWSAccessKeyId=...&Expires=...&Signature=..."
                  filename:
                    type: string
                    description: |
                      Suggested filename for the video download based on the event timestamp.
                      Format: latest_video_{YYYY-MM-DD_HH-mm-ss}.mp4
                    example: "latest_video_2025-01-17_20-43-56.mp4"
                  videoKey:
                    type: string
                    description: |
                      S3 object key for the video file, useful for logging and tracking.
                      Format: {YYYY-MM-DD}/{eventId}_{deviceMac}_{timestamp}.mp4
                    example: "2025-01-17/28704E113F33_1739819436108.mp4"
                  eventKey:
                    type: string
                    description: |
                      S3 object key for the corresponding event JSON data.
                      Format: {YYYY-MM-DD}/{eventId}_{deviceMac}_{timestamp}.json
                    example: "2025-01-17/28704E113F33_1739819436108.json"
                  timestamp:
                    type: integer
                    format: int64
                    description: |
                      Unix timestamp in milliseconds when the alarm event occurred.
                    example: 1739819436108
                  eventDate:
                    type: string
                    description: |
                      Human-readable date and time when the event occurred.
                      Format: YYYY-MM-DD HH:mm:ss
                    example: "2025-01-17 20:43:56"
                  expiresAt:
                    type: string
                    description: |
                      When the download URL expires in UTC.
                      Format: YYYY-MM-DD HH:mm:ss UTC
                    example: "2025-01-17 21:43:56 UTC"
                  eventData:
                    type: object
                    nullable: true
                    description: |
                      Complete alarm event details from the corresponding JSON file, including device name,
                      trigger type, zones, timestamps, and other event metadata. May be null if the
                      corresponding event file is not found.
                    properties:
                      name:
                        type: string
                        description: "Name of the alarm configuration"
                        example: "Motion Detection Alert"
                      timestamp:
                        type: integer
                        format: int64
                        description: "Unix timestamp when the event occurred"
                        example: 1739819436108
                      triggers:
                        type: array
                        description: "List of trigger events that activated this alarm"
                        items:
                          type: object
                          properties:
                            key:
                              type: string
                              description: "Type of detection (motion, person, vehicle, etc.)"
                              example: "motion"
                            device:
                              type: string
                              description: "MAC address of the device that detected the event"
                              example: "28704E113F33"
                            deviceName:
                              type: string
                              description: "Human-readable device name"
                              example: "Backyard West"
                            eventId:
                              type: string
                              description: "Unique event identifier in Unifi Protect"
                              example: "67b389ab005ec703e40075a5"
                            date:
                              type: string
                              description: "ISO formatted event timestamp"
                              example: "2025-01-17T20:43:56"
                            zones:
                              type: object
                              description: "Detection zones that were triggered"
                              properties:
                                zone:
                                  type: array
                                  items:
                                    type: string
                                  example: ["entrance", "driveway"]
                                line:
                                  type: array
                                  items:
                                    type: string
                                  example: ["property_line"]
                                loiter:
                                  type: array
                                  items:
                                    type: string
                                  example: []
                  message:
                    type: string
                    description: |
                      Instructions for using the download URL.
                    example: "Use the downloadUrl to download the video file directly. URL expires in 1 hour."
              examples:
                motionVideo:
                  summary: Motion detection video URL with event data
                  description: "Download URL and complete event details for motion detection event from Backyard West camera"
                  value:
                    downloadUrl: "https://s3.amazonaws.com/unifi-events/2025-01-17/28704E113F33_1739819436108.mp4?AWSAccessKeyId=AKIAIOSFODNN7EXAMPLE&Expires=1739823036&Signature=example..."
                    filename: "latest_video_2025-01-17_20-43-56.mp4"
                    videoKey: "2025-01-17/28704E113F33_1739819436108.mp4"
                    eventKey: "2025-01-17/28704E113F33_1739819436108.json"
                    timestamp: 1739819436108
                    eventDate: "2025-01-17 20:43:56"
                    expiresAt: "2025-01-17 21:43:56 UTC"
                    eventData:
                      name: "Motion Detection Alert"
                      timestamp: 1739819436108
                      triggers:
                        - key: "motion"
                          device: "28704E113F33"
                          deviceName: "Backyard West"
                          eventId: "67b389ab005ec703e40075a5"
                          date: "2025-01-17T20:43:56"
                          zones:
                            zone: []
                            line: []
                            loiter: []
                      sources:
                        - device: "28704E113F64"
                          type: "include"
                      conditions:
                        - condition:
                            type: "is"
                            source: "motion"
                      eventPath: "/protect/events/67b389ab005ec703e40075a5"
                      eventLocalLink: "https://udm.local/protect/events/67b389ab005ec703e40075a5"
                    message: "Use the downloadUrl to download the video file directly. URL expires in 1 hour."
        '404':
          description: No video files found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noVideos:
                  summary: No videos in storage
                  value:
                    msg: "No video files found"
                searchTimeout:
                  summary: No videos found within search window
                  value:
                    msg: "No video files found in the last 30 days"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                s3Error:
                  summary: S3 access error
                  value:
                    msg: "Error retrieving latest video: Access denied"
                configError:
                  summary: Configuration error
                  value:
                    msg: "Server configuration error: StorageBucket not configured"
                searchError:
                  summary: Search algorithm error
                  value:
                    msg: "Error retrieving latest video: Failed to search date folders"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key required for all requests. 
        
        **Obtaining API Key:**
        1. Deploy the CloudFormation stack
        2. Retrieve from AWS API Gateway console
        3. Or use AWS CLI: `aws apigateway get-api-keys --include-values`
        
        **Usage:**
        Include in all requests as a header:
        ```
        X-API-Key: your-api-key-here
        ```
        
        **Security Notes:**
        - Keep API keys secure and rotate regularly
        - Use different keys for different environments
        - Monitor API key usage in CloudWatch

  schemas:
    UnifiWebhookRequest:
      type: object
      required:
        - alarm
        - timestamp
      properties:
        alarm:
          $ref: '#/components/schemas/AlarmObject'
        timestamp:
          type: integer
          format: int64
          minimum: 1000000000000
          maximum: 9999999999999
          description: |
            Unix timestamp in milliseconds when the event occurred.
            Must be between 1000000000000 (2001-09-09) and 9999999999999 (2286-11-20).
          example: 1739819436108
      description: |
        Webhook request payload sent by Unifi Dream Machine Protect systems when alarm events occur.
        
        **Source:** Unifi Protect webhook configuration
        **Content-Type:** application/json
        **Frequency:** Real-time (as events occur)

    AlarmObject:
      type: object
      required:
        - name
        - triggers
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: |
            Human-readable name of the alarm configuration as defined in Unifi Protect.
            This corresponds to the alarm rule name in the Unifi Protect web interface.
          example: "Backup Alarm Event"
        sources:
          type: array
          items:
            $ref: '#/components/schemas/AlarmSource'
          description: |
            List of devices included or excluded in the alarm configuration.
            Defines which cameras and devices are monitored by this alarm rule.
          minItems: 0
          maxItems: 50
        conditions:
          type: array
          items:
            $ref: '#/components/schemas/AlarmCondition'
          description: |
            Conditions that must be met to trigger the alarm.
            These define the types of detection events that activate the alarm.
          minItems: 0
          maxItems: 20
        triggers:
          type: array
          minItems: 1
          maxItems: 10
          items:
            $ref: '#/components/schemas/AlarmTrigger'
          description: |
            List of trigger events that activated this alarm.
            At least one trigger is required for a valid alarm event.
        eventPath:
          type: string
          description: |
            Internal path to the event in Unifi Protect system.
            Used for linking back to the original event in the Unifi interface.
          example: "/protect/events/67b389ab005ec703e40075a5"
        eventLocalLink:
          type: string
          format: uri
          description: |
            Local URL to view the event in Unifi Protect web interface.
            Only accessible from networks that can reach the UDM.
          example: "https://udm.local/protect/events/67b389ab005ec703e40075a5"

    AlarmSource:
      type: object
      required:
        - device
        - type
      properties:
        device:
          type: string
          pattern: '^[A-Fa-f0-9]{12}$'
          description: |
            Device MAC address in 12-character hexadecimal format (no separators).
            This uniquely identifies the Unifi Protect camera or device.
            
            **Format:** AABBCCDDEEFF (no colons, dashes, or spaces)
          example: "28704E113F64"
        type:
          type: string
          enum: ["include", "exclude"]
          description: |
            Whether this device is included or excluded from the alarm rule.
            
            - **include**: Device events will trigger the alarm
            - **exclude**: Device events will not trigger the alarm
          example: "include"

    AlarmCondition:
      type: object
      required:
        - condition
      properties:
        condition:
          type: object
          required:
            - type
            - source
          properties:
            type:
              type: string
              enum: ["is", "is_not"]
              description: |
                Type of condition evaluation.
                
                - **is**: Alarm triggers when the source event occurs
                - **is_not**: Alarm triggers when the source event does NOT occur
              example: "is"
            source:
              type: string
              enum: ["motion", "person", "vehicle", "package", "intrusion", "object"]
              description: |
                Type of detection that the condition evaluates.
                
                - **motion**: General motion detection
                - **person**: AI-powered person detection
                - **vehicle**: AI-powered vehicle detection
                - **package**: AI-powered package detection
                - **intrusion**: Zone intrusion detection
                - **object**: General object detection
              example: "motion"

    AlarmTrigger:
      type: object
      required:
        - key
        - device
        - eventId
      properties:
        key:
          type: string
          enum: ["motion", "person", "vehicle", "package", "intrusion", "object"]
          description: |
            Type of detection that triggered the alarm.
            Must match one of the condition sources in the alarm configuration.
          example: "motion"
        device:
          type: string
          pattern: '^[A-Fa-f0-9]{12}$'
          description: |
            MAC address of the device that detected the event.
            Format: 12 hexadecimal characters without separators.
          example: "28704E113F33"
        eventId:
          type: string
          minLength: 1
          maxLength: 50
          description: |
            Unique identifier for this specific detection event in Unifi Protect.
            Used to link back to video footage and event details.
          example: "67b389ab005ec703e40075a5"
        zones:
          type: object
          properties:
            zone:
              type: array
              items:
                type: string
              description: |
                Named detection zones within the camera's field of view that were triggered.
                These correspond to zones configured in Unifi Protect.
              example: ["entrance", "driveway"]
            line:
              type: array
              items:
                type: string
              description: |
                Line crossing detection zones that were triggered.
                Used for tracking movement across defined boundaries.
              example: ["property_line"]
            loiter:
              type: array
              items:
                type: string
              description: |
                Loitering detection zones that were triggered.
                Used for detecting prolonged presence in specific areas.
              example: []
          description: |
            Specific zones within the camera's field of view that triggered the detection.
            Zones are configured in the Unifi Protect web interface.
        deviceName:
          type: string
          description: |
            Human-readable device name (added during processing).
            Mapped from MAC address using environment variables.
          example: "Backyard West"
          readOnly: true
        date:
          type: string
          format: date-time
          description: |
            ISO 8601 formatted timestamp (added during processing).
            Converted from the Unix timestamp for readability.
          example: "2025-01-17T20:43:56"
          readOnly: true
        eventKey:
          type: string
          description: |
            Unique key for retrieving this event (added during processing).
            Format: {eventId}_{deviceMac}_{timestamp}.json
          example: "28704E113F33_1739819436108.json"
          readOnly: true

    StoredAlarmEvent:
      allOf:
        - $ref: '#/components/schemas/AlarmObject'
        - type: object
          properties:
            timestamp:
              type: integer
              format: int64
              description: |
                Unix timestamp in milliseconds when the event occurred.
                Original timestamp from the webhook request.
              example: 1739819436108
      description: |
        Alarm event as stored in S3 with additional processing metadata.
        
        **Storage Location:** `s3://{bucket}/{YYYY-MM-DD}/{eventId}_{deviceMac}_{timestamp}.json`
        **Retention:** Indefinite (configure S3 lifecycle policies as needed)
        **Encryption:** Server-side encryption with AES-256

    SuccessResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: |
            Detailed success message with event processing information.
            Includes event key, device name, and formatted timestamp for reference.
          example: "bf-prod-lambda-unifi-protect-event-backup-api has successfully processed the Unifi alarm event webhook with key 28704E113F33_1739819436108.json for Backyard West that occurred at 2025-01-17T20:43:56."

    QueuedEventResponse:
      type: object
      required:
        - msg
        - eventId
        - device
        - processingDelay
        - messageId
        - estimatedProcessingTime
      properties:
        msg:
          type: string
          description: Confirmation message that the event has been queued
          example: "Alarm event has been queued for processing"
        eventId:
          type: string
          description: Unifi Protect event identifier
          example: "67b389ab005ec703e40075a5"
        device:
          type: string
          description: Device MAC address that triggered the event
          example: "28704E113F33"
        processingDelay:
          type: integer
          description: Delay in seconds before processing begins
          example: 120
        messageId:
          type: string
          description: SQS message identifier for tracking
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        estimatedProcessingTime:
          type: string
          description: Estimated time when processing will begin (UTC)
          example: "2025-01-17T20:47:56 UTC"

    ErrorResponse:
      type: object
      required:
        - msg
      properties:
        msg:
          type: string
          description: |
            Descriptive error message explaining what went wrong.
            Includes error code (400, 500, etc.) and specific details for troubleshooting.
          example: "ERROR 400: malformed or invalid request format"

    VideoDownloadResponse:
      type: object
      required:
        - downloadUrl
        - filename
        - videoKey
        - eventKey
        - eventId
        - timestamp
        - eventDate
        - expiresAt
        - message
      properties:
        downloadUrl:
          type: string
          format: uri
          description: |
            Presigned S3 URL for direct video download. Valid for 1 hour.
            Use this URL to download the video file directly from S3.
          example: "https://s3.amazonaws.com/bucket/2025-01-17/28704E113F33_1739819436108.mp4?X-Amz-Signature=..."
        filename:
          type: string
          description: |
            Suggested filename for the downloaded video file.
            Format: event_{eventId}_{YYYY-MM-DD_HH-mm-ss}.mp4
          example: "event_67b389ab005ec703e40075a5_2025-01-17_20-43-56.mp4"
        videoKey:
          type: string
          description: |
            S3 object key for the video file.
            Format: {YYYY-MM-DD}/{eventId}_{deviceMac}_{timestamp}.mp4
          example: "2025-01-17/28704E113F33_1739819436108.mp4"
        eventKey:
          type: string
          description: |
            S3 object key for the corresponding event JSON data.
            Format: {YYYY-MM-DD}/{eventId}_{deviceMac}_{timestamp}.json
          example: "2025-01-17/28704E113F33_1739819436108.json"
        eventId:
          type: string
          description: |
            Unifi Protect event identifier that was searched for.
          example: "67b389ab005ec703e40075a5"
        timestamp:
          type: integer
          format: int64
          description: |
            Unix timestamp (milliseconds) when the event occurred.
          example: 1739819436108
        eventDate:
          type: string
          description: |
            Human-readable event date and time in format: YYYY-MM-DD HH:mm:ss
          example: "2025-01-17 20:43:56"
        expiresAt:
          type: string
          description: |
            When the download URL expires in format: YYYY-MM-DD HH:mm:ss UTC
          example: "2025-01-17 21:43:56 UTC"
        eventData:
          type: object
          description: |
            Complete alarm event details from the corresponding JSON file.
            Includes device information, trigger details, zones, and all metadata.
          properties:
            name:
              type: string
              example: "Motion Detection Alert"
            timestamp:
              type: integer
              format: int64
              example: 1739819436108
            triggers:
              type: array
              items:
                type: object
                properties:
                  key:
                    type: string
                    example: "motion"
                  device:
                    type: string
                    example: "28704E113F33"
                  eventId:
                    type: string
                    example: "67b389ab005ec703e40075a5"
                  deviceName:
                    type: string
                    example: "Backyard West"
                  zones:
                    type: object
        message:
          type: string
          description: |
            Instructions for using the download URL and expiration information.
          example: "Use the downloadUrl to download the video file directly. URL expires in 1 hour."

tags:
  - name: Alarm Events
    description: |
      Processing of incoming alarm webhook events from Unifi Protect systems.
      
      **Typical Flow:**
      1. Unifi Protect detects motion/person/vehicle
      2. Alarm rule evaluates conditions
      3. Webhook sent to this API
      4. Event processed and stored in S3
      5. Success response returned to Unifi
      
  - name: Event Retrieval
    description: |
      Retrieval of stored alarm events for analysis and integration.
      
      **Use Cases:**
      - Dashboard integration
      - Historical analysis
      - Event correlation
      - Audit trails
      
  - name: Video Retrieval
    description: |
      Direct access to video files associated with alarm events.
      
      **Features:**
      - Optimized search using date-organized folder structure
      - Efficient backwards chronological search algorithm
      - Binary MP4 file download with proper headers
      - Automatic filename suggestion based on event timestamp
      
      **Use Cases:**
      - Quick access to recent security footage
      - Mobile security applications
      - Automated monitoring and alerting
      - Integration with third-party security systems
      
  - name: CORS
    description: |
      Cross-Origin Resource Sharing support for web applications.
      
      **Supported Origins:** All origins (`*`)
      **Supported Methods:** GET, POST, OPTIONS
      **Supported Headers:** Content-Type, X-API-Key

externalDocs:
  description: |
    Complete project documentation including setup, deployment, and troubleshooting guides.
  url: https://github.com/engineerthefuture/unifi-protect-event-backup-api/blob/main/README.md
